name: Theme Validation & Auto-Generation

on:
  pull_request:
    paths:
      - 'clients/**/theme.json'
      - 'design_system/tokens.json'
      - 'clients/.schema/theme.schema.json'
      - 'scripts/merge_theme.py'
      - 'src/server/theme_routes.py'
      - 'src/orchestrator/style.py'
  push:
    branches:
      - main
    paths:
      - 'clients/**/theme.json'
      - 'design_system/tokens.json'

jobs:
  validate-themes:
    name: Validate Client Themes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml rich typer

      - name: List client themes (sanity check)
        run: |
          python -m src.orchestrator.cli style list

      - name: Detect changed themes
        id: changed-themes
        run: |
          # Get list of changed theme files
          git fetch origin ${{ github.base_ref }}
          CHANGED_THEMES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "clients/.*/theme.json" | sed 's|clients/\(.*\)/theme.json|\1|' || echo "")

          if [ -z "$CHANGED_THEMES" ]; then
            echo "No theme changes detected"
            echo "themes=" >> $GITHUB_OUTPUT
          else
            echo "Changed themes: $CHANGED_THEMES"
            echo "themes=$CHANGED_THEMES" >> $GITHUB_OUTPUT
          fi

      - name: Validate changed themes
        if: steps.changed-themes.outputs.themes != ''
        run: |
          THEMES="${{ steps.changed-themes.outputs.themes }}"
          FAILED=0

          for client in $THEMES; do
            echo "::group::Validating theme: $client"

            if ! python scripts/merge_theme.py --client "$client" --validate-only; then
              echo "::error file=clients/$client/theme.json::Theme validation failed for $client"
              FAILED=1
            fi

            echo "::endgroup::"
          done

          if [ $FAILED -eq 1 ]; then
            echo "::error::One or more theme validations failed"
            exit 1
          fi

      - name: Check brand constraints
        if: steps.changed-themes.outputs.themes != ''
        run: |
          THEMES="${{ steps.changed-themes.outputs.themes }}"
          FAILED=0

          for client in $THEMES; do
            echo "::group::Checking brand constraints: $client"

            THEME_FILE="clients/$client/theme.json"

            # Check for emojis constraint
            if ! grep -q '"allowEmojis".*false' "$THEME_FILE"; then
              echo "::error file=$THEME_FILE::Missing or incorrect allowEmojis constraint"
              FAILED=1
            fi

            # Check for gridlines constraint
            if ! grep -q '"allowGridlines".*false' "$THEME_FILE"; then
              echo "::error file=$THEME_FILE::Missing or incorrect allowGridlines constraint"
              FAILED=1
            fi

            # Check for label-first constraint
            if ! grep -q '"labelFirst".*true' "$THEME_FILE"; then
              echo "::error file=$THEME_FILE::Missing or incorrect labelFirst constraint"
              FAILED=1
            fi

            # Check color format (hex codes)
            if grep -E '"#[^"]{7,}"' "$THEME_FILE"; then
              echo "::error file=$THEME_FILE::Invalid hex color format (must be #RRGGBB)"
              FAILED=1
            fi

            # Check font fallbacks
            if grep -Po '"fontFamily[^"]*":\s*"[^"]*"' "$THEME_FILE" | grep -v -E '(sans-serif|serif|monospace)'; then
              echo "::error file=$THEME_FILE::Font family must include fallback (sans-serif, serif, or monospace)"
              FAILED=1
            fi

            echo "::endgroup::"
          done

          if [ $FAILED -eq 1 ]; then
            echo "::error::Brand constraint violations detected"
            exit 1
          fi

      - name: Run theme-related tests
        run: |
          pip install pytest pytest-mock httpx
          pip install -r requirements-dataplatform.txt
          pytest -q tests/design tests/server tests/orchestrator -k "theme or tokens or merge or style" -v || true

  generate-tokens:
    name: Generate Tokens on Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml

      - name: Detect changed themes
        id: changed-themes
        run: |
          # Get list of changed theme files in last commit
          CHANGED_THEMES=$(git diff --name-only HEAD~1 HEAD | grep "clients/.*/theme.json" | sed 's|clients/\(.*\)/theme.json|\1|' || echo "")

          if [ -z "$CHANGED_THEMES" ]; then
            echo "No theme changes in last commit"
            echo "themes=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed themes: $CHANGED_THEMES"
            echo "themes=$CHANGED_THEMES" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate tokens for changed themes
        if: steps.changed-themes.outputs.has_changes == 'true'
        run: |
          THEMES="${{ steps.changed-themes.outputs.themes }}"

          for client in $THEMES; do
            echo "::group::Generating tokens for: $client"

            python scripts/merge_theme.py --client "$client" --output design_system/.generated

            echo "âœ“ Generated tokens for $client"
            ls -lh design_system/.generated/$client.*

            echo "::endgroup::"
          done

      - name: Commit generated tokens
        if: steps.changed-themes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add design_system/.generated/

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            THEMES="${{ steps.changed-themes.outputs.themes }}"
            git commit -m "chore: auto-generate tokens for changed themes

Generated tokens for: $THEMES

This commit was automatically created by the theme-ci workflow."

            git push
          fi

      - name: Upload generated tokens as artifacts
        if: steps.changed-themes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: generated-tokens
          path: design_system/.generated/
          retention-days: 30

  test-theme-system:
    name: Test Theme System
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install -r requirements-dataplatform.txt

      - name: Run theme schema tests
        run: |
          pytest tests/design/test_theme_schema.py -v --tb=short

      - name: Run theme merge tests
        run: |
          pytest tests/design/test_merge_theme.py -v --tb=short

      - name: Run theme API tests
        run: |
          pytest tests/server/test_theme_routes.py -v --tb=short

      - name: Run style CLI tests
        run: |
          pytest tests/orchestrator/test_style_cli.py -v --tb=short
