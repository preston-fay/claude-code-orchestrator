name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 9 * * MON'  # Weekly Monday 9am UTC

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.10', '3.11']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install -r requirements-dataplatform.txt

      - name: Lint with ruff
        run: |
          ruff check src/ tests/
        continue-on-error: true

      - name: Check code formatting with black
        run: |
          black --check src/ tests/
        continue-on-error: true

      - name: Type check with mypy
        run: |
          mypy src/ --ignore-missing-imports
        continue-on-error: true

      - name: Enforce KDS guardrails (no inline CSS/colors)
        run: |
          echo "Checking for inline styles in orchestrator HTML producers..."
          ! grep -RIn --include="*.py" 'style\s*=' src/orchestrator || (echo "::error::Inline style attribute found in orchestrator code" && exit 1)
          echo "Checking for hardcoded hex colors in orchestrator HTML producers..."
          ! grep -RIn --include="*.py" '#[0-9a-fA-F]\{3,6\}' src/orchestrator || (echo "::error::Hardcoded hex color found in orchestrator code" && exit 1)
          echo "âœ… KDS guardrails passed"

      - name: Run tests with pytest
        run: |
          pytest -v --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'

  data-pipeline-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run demo pipeline
        run: |
          python -m src.pipelines.demo_pipeline

      - name: Verify pipeline artifacts
        run: |
          ls -la models/
          ls -la data/processed/
          cat models/metrics.json

      - name: Check pipeline status
        run: |
          python -m src.cli status

  repo-hygiene:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install -r requirements-dataplatform.txt

      - name: Run repository scanner
        run: |
          python3 scripts/scan_repo.py
        continue-on-error: true

      - name: Run dead code analysis
        run: |
          python3 scripts/dead_code_report.py
        continue-on-error: true

      - name: Check notebook hygiene
        run: |
          python3 scripts/notebook_sanitizer.py
        continue-on-error: true

      - name: Aggregate hygiene reports
        run: |
          python3 scripts/hygiene_glue.py
        continue-on-error: true

      - name: Upload hygiene reports
        uses: actions/upload-artifact@v4
        with:
          name: hygiene-reports
          path: reports/
        if: always()

      - name: Check for hygiene violations
        run: |
          # Fail if non-whitelisted large files found
          if [ -f reports/large_files.csv ]; then
            count=$(python3 -c "import csv; print(sum(1 for row in csv.DictReader(open('reports/large_files.csv')) if row['whitelisted'].lower() == 'false'))")
            if [ "$count" -gt 0 ]; then
              echo "âŒ Found $count non-whitelisted large files"
              echo "Review reports/large_files.csv"
              exit 1
            fi
          fi

          # Fail if non-whitelisted notebooks with outputs found
          if [ -f reports/notebook_sanitizer.md ]; then
            needs_cleanup=$(grep "Requiring cleanup" reports/notebook_sanitizer.md | grep -oE '[0-9]+' || echo "0")
            if [ "$needs_cleanup" -gt 0 ]; then
              echo "âŒ Found $needs_cleanup notebooks with outputs (not whitelisted)"
              echo "Run: orchestrator run repo-hygiene --apply"
              echo "Or add to whitelist_globs in configs/hygiene.yaml"
              exit 1
            fi
          fi

          echo "âœ… Hygiene checks passed"
        continue-on-error: false

      - name: Post hygiene summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryPath = 'reports/hygiene_summary.json';

            if (!fs.existsSync(summaryPath)) {
              console.log('No hygiene summary found');
              return;
            }

            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));

            const scoreEmoji = summary.cleanliness_score >= 95 ? 'ğŸŸ¢' :
                              summary.cleanliness_score >= 85 ? 'ğŸŸ¡' : 'ğŸ”´';

            const body = `## ğŸ§¹ Repository Hygiene Report

            ${scoreEmoji} **Cleanliness Score:** ${summary.cleanliness_score}/100 (Grade: ${summary.grade})

            ### Stats
            - ğŸ“ Orphans: ${summary.stats.orphans}
            - ğŸ“¦ Large Files: ${summary.stats.large_files}
            - ğŸ’€ Dead Code (functions): ${summary.stats.dead_code_functions}
            - ğŸ““ Notebooks needing cleanup: ${summary.stats.notebooks_needs_cleanup}
            - ğŸ” Secret findings: ${summary.stats.secrets_findings}

            ### Quality Gates
            ${summary.quality_gates.orphans_warn ? 'âš ï¸ **Warning:** Orphans exceed threshold' : 'âœ… Orphans OK'}
            ${summary.quality_gates.orphans_block ? 'ğŸš« **BLOCKED:** Too many orphans' : ''}
            ${summary.quality_gates.score_pass ? 'âœ… **Score PASSED**' : 'âŒ **Score FAILED** (< ' + summary.thresholds.min_cleanliness_score + ')'}

            ğŸ“Š [View full reports in artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Post hygiene summary (step summary)
        if: always()
        run: |
          if [ -f reports/repo_hygiene_report.md ]; then
            echo "## ğŸ§¹ Repository Hygiene Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            head -30 reports/repo_hygiene_report.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“Š [View full reports in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi

  repo-hygiene-weekly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install -r requirements-dataplatform.txt

      - name: Run repository scanner
        run: |
          python3 scripts/scan_repo.py
        continue-on-error: true

      - name: Run dead code analysis
        run: |
          python3 scripts/dead_code_report.py
        continue-on-error: true

      - name: Check notebook hygiene
        run: |
          python3 scripts/notebook_sanitizer.py
        continue-on-error: true

      - name: Aggregate hygiene reports
        run: |
          python3 scripts/hygiene_glue.py
        continue-on-error: true

      - name: Log hygiene trend
        run: |
          python3 scripts/hygiene_trend.py
        continue-on-error: true

      - name: Render hygiene trend chart
        run: |
          python3 scripts/render_hygiene_trend.py
        continue-on-error: true

      - name: Generate cleanliness badge
        run: |
          python3 scripts/generate_cleanliness_badge.py
        continue-on-error: true

      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/hygiene_trend.csv docs/hygiene_trend.png docs/badges/cleanliness.svg
          git diff --cached --quiet || git commit -m "chore: update hygiene metrics (weekly automation)

          ğŸ“Š Automated hygiene trend update

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
          git push
        continue-on-error: true
