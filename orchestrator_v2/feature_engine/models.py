"""
Data models for Feature Orchestration Engine.

Defines the data structures for feature requests, plans, and build results.
"""

from datetime import datetime
from enum import Enum
from typing import Any

from pydantic import BaseModel, Field


class FeatureStatus(str, Enum):
    """Status of a feature request."""
    SUBMITTED = "submitted"
    PLANNED = "planned"
    APPROVED = "approved"
    BUILDING = "building"
    COMPLETED = "completed"
    FAILED = "failed"


class BuildStatus(str, Enum):
    """Status of a feature build."""
    SUCCESS = "success"
    PARTIAL = "partial"
    FAILED = "failed"


class FeatureRequest(BaseModel):
    """A feature request submitted by a user."""
    id: str
    project_id: str
    title: str
    description: str
    created_at: datetime = Field(default_factory=datetime.utcnow)
    created_by: str = "system"
    status: FeatureStatus = FeatureStatus.SUBMITTED
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    metadata: dict[str, Any] = Field(default_factory=dict)


class FeaturePlan(BaseModel):
    """Plan generated by Architect agent for a feature."""
    feature_id: str
    project_id: str
    prd: str  # Product Requirements Document content
    acceptance_criteria: list[str] = Field(default_factory=list)
    adr_summaries: list[str] = Field(default_factory=list)
    risks: list[str] = Field(default_factory=list)
    estimated_effort: str = ""  # e.g., "2-3 days"
    created_at: datetime = Field(default_factory=datetime.utcnow)


class RepoChange(BaseModel):
    """A planned change to a repository file."""
    file_path: str
    action: str  # "create", "modify", "delete"
    description: str = ""


class FeatureBuildPlan(BaseModel):
    """Build plan generated by Developer agent."""
    feature_id: str
    project_id: str
    steps: list[str] = Field(default_factory=list)
    repo_changes: list[RepoChange] = Field(default_factory=list)
    required_agents: list[str] = Field(default_factory=list)
    required_skills: list[str] = Field(default_factory=list)
    required_tests: list[str] = Field(default_factory=list)
    target_branch: str = "main"
    created_at: datetime = Field(default_factory=datetime.utcnow)


class TestResult(BaseModel):
    """Result of a test execution."""
    test_name: str
    passed: bool
    output: str = ""
    duration_ms: int = 0


class FeatureBuildResult(BaseModel):
    """Result of building a feature."""
    feature_id: str
    project_id: str
    status: BuildStatus
    branch_name: str = ""
    diff_summary: list[str] = Field(default_factory=list)
    created_files: list[str] = Field(default_factory=list)
    updated_files: list[str] = Field(default_factory=list)
    deleted_files: list[str] = Field(default_factory=list)
    test_results: list[TestResult] = Field(default_factory=list)
    governance_results: str = ""
    pr_url: str | None = None
    pr_number: int | None = None
    commit_sha: str = ""
    build_logs: list[str] = Field(default_factory=list)
    started_at: datetime = Field(default_factory=datetime.utcnow)
    completed_at: datetime | None = None
    error_message: str | None = None


class FeatureDetail(BaseModel):
    """Complete detail of a feature including request, plan, and result."""
    request: FeatureRequest
    plan: FeaturePlan | None = None
    build_plan: FeatureBuildPlan | None = None
    result: FeatureBuildResult | None = None
