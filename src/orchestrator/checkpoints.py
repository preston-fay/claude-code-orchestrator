"""Checkpoint validation for orchestrator phases."""

from pathlib import Path
from typing import List, Dict, Any
from datetime import datetime
import glob

from .types import ValidationResult, ValidationStatus


def validate_artifacts(
    artifacts_required: List[str],
    project_root: Path,
    phase_name: str,
) -> ValidationResult:
    """
    Validate that required artifacts exist and are non-empty.

    Args:
        artifacts_required: List of glob patterns (e.g., ["docs/*.md", "src/main.py"])
        project_root: Root directory to search from
        phase_name: Name of the phase being validated (for reporting)

    Returns:
        ValidationResult with status and detailed findings
    """
    found_files = []
    missing_patterns = []

    for pattern in artifacts_required:
        # Resolve glob pattern
        matches = list(project_root.glob(pattern))

        if not matches:
            missing_patterns.append(pattern)
        else:
            # Check if files are non-empty
            for match in matches:
                if match.is_file() and match.stat().st_size > 0:
                    # Store relative path
                    rel_path = match.relative_to(project_root)
                    found_files.append(str(rel_path))

    # Determine status
    if not missing_patterns:
        status = ValidationStatus.PASS
    elif found_files:
        status = ValidationStatus.PARTIAL
    else:
        status = ValidationStatus.FAIL

    # Generate validation report
    report_path = _generate_validation_report(
        phase_name=phase_name,
        status=status,
        required=artifacts_required,
        found=found_files,
        missing=missing_patterns,
        project_root=project_root,
    )

    notes = ""
    if status == ValidationStatus.PARTIAL:
        notes = f"Some artifacts missing: {len(missing_patterns)} pattern(s) unmatched"
    elif status == ValidationStatus.FAIL:
        notes = "No required artifacts found"

    return ValidationResult(
        status=status,
        required=artifacts_required,
        found=found_files,
        missing=missing_patterns,
        validation_report_path=str(report_path),
        notes=notes,
    )


def _generate_validation_report(
    phase_name: str,
    status: ValidationStatus,
    required: List[str],
    found: List[str],
    missing: List[str],
    project_root: Path,
) -> Path:
    """Generate markdown validation report."""
    reports_dir = project_root / "reports"
    reports_dir.mkdir(parents=True, exist_ok=True)

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    report_path = reports_dir / f"checkpoint_validation_{phase_name}.md"

    status_emoji = {
        ValidationStatus.PASS: "✅",
        ValidationStatus.PARTIAL: "⚠️",
        ValidationStatus.FAIL: "❌",
    }

    with open(report_path, "w") as f:
        f.write(f"# Checkpoint Validation: {phase_name}\n\n")
        f.write(f"**Status:** {status_emoji.get(status, '❓')} {status.value.upper()}\n\n")
        f.write(f"**Validated:** {datetime.now().isoformat()}\n\n")

        f.write("## Required Artifacts\n\n")
        for pattern in required:
            f.write(f"- `{pattern}`\n")

        f.write(f"\n## Validation Results\n\n")
        f.write(f"- **Found:** {len(found)} file(s)\n")
        f.write(f"- **Missing:** {len(missing)} pattern(s)\n\n")

        if found:
            f.write("### Found Artifacts\n\n")
            for artifact in sorted(found):
                f.write(f"- ✅ `{artifact}`\n")
            f.write("\n")

        if missing:
            f.write("### Missing Patterns\n\n")
            for pattern in missing:
                f.write(f"- ❌ `{pattern}` (no matches)\n")
            f.write("\n")

        # Status interpretation
        f.write("## Status Interpretation\n\n")
        if status == ValidationStatus.PASS:
            f.write("All required artifacts found and validated. ✅\n")
        elif status == ValidationStatus.PARTIAL:
            f.write("Some required artifacts are missing. Phase may need revision. ⚠️\n")
        else:
            f.write("Critical artifacts missing. Phase must be completed before proceeding. ❌\n")

        f.write(f"\n---\n*Generated by Orchestrator Checkpoint Validation*\n")

    return report_path


def get_checkpoint_summary(project_root: Path) -> Dict[str, Any]:
    """
    Get summary of all checkpoint validations.

    Args:
        project_root: Project root directory

    Returns:
        Dictionary with checkpoint summary statistics
    """
    reports_dir = project_root / "reports"

    if not reports_dir.exists():
        return {"total": 0, "by_phase": {}}

    # Find all checkpoint validation reports
    checkpoint_files = list(reports_dir.glob("checkpoint_validation_*.md"))

    summary = {
        "total": len(checkpoint_files),
        "by_phase": {},
    }

    for report_file in checkpoint_files:
        # Extract phase name from filename
        # checkpoint_validation_<phase>.md
        phase = report_file.stem.replace("checkpoint_validation_", "")

        # Quick parse for status (read first 10 lines)
        with open(report_file) as f:
            lines = [f.readline() for _ in range(10)]
            content = "".join(lines)

            if "✅ PASS" in content:
                status = "pass"
            elif "⚠️ PARTIAL" in content:
                status = "partial"
            else:
                status = "fail"

        summary["by_phase"][phase] = {
            "status": status,
            "report": str(report_file.relative_to(project_root)),
        }

    return summary
