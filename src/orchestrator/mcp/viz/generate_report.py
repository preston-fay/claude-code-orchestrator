"""Generate HTML reports from markdown content."""

from pathlib import Path
from typing import Dict, Optional


def generate_report(
    content: str,
    *,
    output_path: Optional[str] = None,
    title: str = "Analysis Report",
    metadata: Optional[Dict[str, str]] = None,
) -> str:
    """Generate an HTML report from markdown content.

    Args:
        content: Markdown content for the report
        output_path: Path to save HTML file (default: reports/report.html)
        title: Report title (default: "Analysis Report")
        metadata: Optional metadata dict to include in report header

    Returns:
        str: Path to saved HTML file

    Raises:
        ValueError: If content is empty

    Example:
        >>> markdown = '''
        ... # Data Analysis Results
        ...
        ... ## Summary
        ... - Total rows: 1000
        ... - Columns: 5
        ...
        ... ## Key Findings
        ... 1. Average value: 42.5
        ... 2. No missing data
        ... '''
        >>> path = generate_report(markdown, title="Q4 Analysis")
        >>> print(path)
        reports/report.html

    Note:
        This function creates a simple HTML report. For markdown rendering,
        it uses basic conversion. For advanced features, consider using
        markdown libraries like markdown2 or mistune.
    """
    if not content or not content.strip():
        raise ValueError("Report content cannot be empty")

    # Prepare output path
    if output_path is None:
        reports_dir = Path("reports")
        reports_dir.mkdir(exist_ok=True)
        output_path = "reports/report.html"

    # Ensure output directory exists
    Path(output_path).parent.mkdir(parents=True, exist_ok=True)

    # Convert markdown to HTML (basic implementation)
    html_content = _markdown_to_html(content)

    # Build metadata section
    metadata_html = ""
    if metadata:
        metadata_items = "".join(
            f"<li><strong>{key}:</strong> {value}</li>" for key, value in metadata.items()
        )
        metadata_html = f"""
        <div class="metadata">
            <h3>Report Metadata</h3>
            <ul>
                {metadata_items}
            </ul>
        </div>
        """

    # Create full HTML document
    html_template = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }}
        h1 {{
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }}
        h2 {{
            color: #34495e;
            margin-top: 30px;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 5px;
        }}
        h3 {{
            color: #555;
        }}
        code {{
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }}
        pre {{
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }}
        pre code {{
            background-color: transparent;
            padding: 0;
        }}
        table {{
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }}
        th, td {{
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }}
        th {{
            background-color: #3498db;
            color: white;
        }}
        tr:nth-child(even) {{
            background-color: #f2f2f2;
        }}
        .metadata {{
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
        }}
        .metadata h3 {{
            margin-top: 0;
        }}
        .metadata ul {{
            list-style-type: none;
            padding-left: 0;
        }}
        img {{
            max-width: 100%;
            height: auto;
        }}
    </style>
</head>
<body>
    <h1>{title}</h1>
    {metadata_html}
    <div class="content">
        {html_content}
    </div>
    <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; color: #777; font-size: 0.9em;">
        <p>Generated by Claude Code Orchestrator</p>
    </footer>
</body>
</html>
"""

    # Write HTML file
    Path(output_path).write_text(html_template, encoding="utf-8")

    return output_path


def _markdown_to_html(markdown: str) -> str:
    """Basic markdown to HTML conversion.

    Supports:
    - Headers (# ## ###)
    - Lists (- or 1.)
    - Bold (**text**)
    - Italic (*text*)
    - Code (`code` and ```blocks```)
    - Links ([text](url))
    """
    lines = markdown.split("\n")
    html_lines = []
    in_code_block = False
    in_list = False

    for line in lines:
        stripped = line.strip()

        # Code blocks
        if stripped.startswith("```"):
            if in_code_block:
                html_lines.append("</code></pre>")
                in_code_block = False
            else:
                html_lines.append("<pre><code>")
                in_code_block = True
            continue

        if in_code_block:
            html_lines.append(line)
            continue

        # Headers
        if stripped.startswith("### "):
            html_lines.append(f"<h3>{stripped[4:]}</h3>")
        elif stripped.startswith("## "):
            html_lines.append(f"<h2>{stripped[3:]}</h2>")
        elif stripped.startswith("# "):
            html_lines.append(f"<h1>{stripped[2:]}</h1>")
        # Lists
        elif stripped.startswith("- ") or stripped.startswith("* "):
            if not in_list:
                html_lines.append("<ul>")
                in_list = True
            html_lines.append(f"<li>{stripped[2:]}</li>")
        elif stripped and stripped[0].isdigit() and ". " in stripped:
            if not in_list:
                html_lines.append("<ol>")
                in_list = True
            html_lines.append(f"<li>{stripped.split('. ', 1)[1]}</li>")
        else:
            if in_list:
                html_lines.append("</ul>")
                in_list = False
            if stripped:
                # Apply inline formatting
                formatted = stripped
                # Bold
                import re
                formatted = re.sub(r'\*\*(.+?)\*\*', r'<strong>\1</strong>', formatted)
                # Italic
                formatted = re.sub(r'\*(.+?)\*', r'<em>\1</em>', formatted)
                # Inline code
                formatted = re.sub(r'`(.+?)`', r'<code>\1</code>', formatted)
                # Links
                formatted = re.sub(r'\[(.+?)\]\((.+?)\)', r'<a href="\2">\1</a>', formatted)

                html_lines.append(f"<p>{formatted}</p>")
            else:
                html_lines.append("<br>")

    if in_list:
        html_lines.append("</ul>")

    return "\n".join(html_lines)
