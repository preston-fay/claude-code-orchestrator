# Claude API Integration Guide

## Overview

The Claude Code Orchestrator supports two execution modes for LLM-based agents:

1. **Stub Mode** (default) - Returns simulated responses for testing workflow logic
2. **Real Mode** - Calls Claude API for actual AI agent execution

## Enabling Real Claude API Calls

### Step 1: Get an API Key

1. Visit https://console.anthropic.com/settings/keys
2. Create a new API key
3. Copy the key (starts with `sk-ant-...`)

### Step 2: Set Environment Variable

#### Option A: Export in Shell
```bash
export ANTHROPIC_API_KEY="sk-ant-your-key-here"
```

#### Option B: Add to Shell Profile
For persistence across sessions, add to `~/.zshrc` or `~/.bashrc`:
```bash
echo 'export ANTHROPIC_API_KEY="sk-ant-your-key-here"' >> ~/.zshrc
source ~/.zshrc
```

#### Option C: Use .env File
```bash
# Copy example file
cp .env.example .env

# Edit .env and set your API key
# ANTHROPIC_API_KEY=sk-ant-your-actual-key

# Load environment
source .env  # or use python-dotenv
```

### Step 3: Verify Configuration

```bash
# Check API key is set
echo $ANTHROPIC_API_KEY | head -c 10

# Should output: sk-ant-api
```

### Step 4: Run Orchestrator

When you start a new orchestrator run, agents without entrypoints will now use real Claude API calls:

```bash
cd /path/to/your/project
orchestrator run start --intake intake.yaml
orchestrator run next
```

**You'll see:**
- Longer execution times (actual AI processing)
- Real analysis and insights in agent responses
- Token usage metadata in output
- Actual artifacts created (not just declared)

## How It Works

### Agent Executor Selection

The orchestrator determines which executor to use for each agent:

```python
# Agents WITH entrypoints → Subprocess Executor
# (e.g., data agent with pipeline commands)
subagents:
  data:
    entrypoints:
      pipeline: "python worldclass_churn.py ..."
    # Uses subprocess execution

# Agents WITHOUT entrypoints → LLM Executor
# (e.g., architect, qa, documentarian)
subagents:
  architect:
    prompt_template: .claude/subagent_prompts/architect.md
    # Uses LLM execution
```

### LLM Executor Behavior

**With ANTHROPIC_API_KEY:**
```
execute_llm()
  → Check for API key ✓
  → Call Claude API
  → Parse response
  → Extract artifacts
  → Return AgentExecResult (executor: "llm_api")
```

**Without ANTHROPIC_API_KEY:**
```
execute_llm()
  → Check for API key ✗
  → Generate stub response
  → Return AgentExecResult (executor: "llm_stub")
```

### API Call Details

**Model:** `claude-sonnet-4-20250514`
**Max Tokens:** 8000
**Temperature:** 0.7
**Timeout:** Configurable (default 1800s)

**Response Format:**
```markdown
[Agent's actual analysis and work]

---
*Generated by architect agent via Claude API*
*Model: claude-sonnet-4-20250514*
*Tokens: 1234 in, 5678 out*
```

## Pricing Considerations

Claude API calls incur costs based on token usage:

- **Input tokens:** Prompt + context
- **Output tokens:** Agent's response

**Example costs (approximate):**
- Planning phase (architect): ~$0.15-0.50
- Data analysis phase: ~$0.30-1.00
- Full workflow run: ~$1-5 depending on complexity

See https://www.anthropic.com/pricing for current rates.

## Troubleshooting

### Issue: "No ANTHROPIC_API_KEY found"

**Symptoms:**
```
⚠️  **STUB MODE**: No ANTHROPIC_API_KEY found. Using simulated response.
```

**Solution:**
1. Set API key as shown in Step 2
2. Verify with `echo $ANTHROPIC_API_KEY`
3. Restart orchestrator run

### Issue: "ImportError: anthropic package not installed"

**Symptoms:**
```
ImportError: anthropic package not installed. Install with: pip install anthropic>=0.40.0
```

**Solution:**
```bash
pip install anthropic>=0.40.0
# OR reinstall orchestrator
pip install -e /path/to/claude-code-orchestrator
```

### Issue: "Claude API error: 401 Unauthorized"

**Symptoms:**
```
⚠️  **FALLBACK MODE**: API call failed (Claude API error: 401...). Using simulated response.
```

**Solution:**
1. Verify API key is correct
2. Check key hasn't been revoked at https://console.anthropic.com/settings/keys
3. Ensure key starts with `sk-ant-`

### Issue: Agent responses still look simulated

**Check executor type in logs:**
```bash
cat .claude/logs/agents/[run_id]_[phase]_[agent].log
```

Look for metadata at bottom of response:
- `executor: llm_api` → Real Claude API was used ✓
- `executor: llm_stub` → Stub mode ✗
- `executor: llm_stub_fallback` → API call failed, fell back to stub ✗

## Testing API Integration

### Quick Test

```python
import os
import asyncio
from pathlib import Path
from orchestrator.executors.llm_exec import execute_llm

# Set API key
os.environ["ANTHROPIC_API_KEY"] = "sk-ant-your-key"

# Test prompt
prompt = "You are an architect agent. Analyze this project structure and suggest improvements."

# Execute
result = asyncio.run(execute_llm(
    prompt=prompt,
    agent_name="architect",
    phase_name="planning",
    project_root=Path.cwd(),
    timeout_seconds=60,
))

print(result.stdout)
print(f"Executor: {result.metadata['executor']}")
```

**Expected output:**
- Detailed analysis (not generic stub response)
- `Executor: llm_api`
- Token usage metadata

## Best Practices

### 1. Development Workflow

**During development:**
- Use stub mode (no API key) for workflow testing
- Verify phase transitions, consensus gates, artifact tracking
- Fast iteration without API costs

**For real work:**
- Set API key
- Run with real Claude for actual analysis
- Review and approve agent outputs

### 2. Cost Management

- Use stub mode for CI/CD and automated tests
- Set API key only in production/staging environments
- Monitor token usage in agent logs

### 3. Prompt Engineering

Agent prompts are in `.claude/subagent_prompts/*.md`:
- Customize for your domain
- Add project-specific context
- Include examples and constraints
- Iterate based on API responses

### 4. Timeouts

Adjust timeout for complex tasks:
```yaml
# In .claude/config.yaml
orchestrator:
  timeout_minutes: 30  # Default
```

Or override per-run:
```bash
orchestrator run next --timeout 3600  # 60 minutes
```

## Security

**⚠️ Important:**
- Never commit `.env` or API keys to git
- Add `.env` to `.gitignore`
- Use environment variables or secret managers
- Rotate API keys periodically
- Restrict API key permissions if possible

## Next Steps

1. Set ANTHROPIC_API_KEY
2. Start a new orchestrator run
3. Watch real AI agents analyze your project
4. Review agent outputs and iterate on prompts
5. Approve phases and continue workflow

---

**Questions?** Check the main [README.md](../README.md) or open an issue on GitHub.
